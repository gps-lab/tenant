name: 'Terraform Azure Deployment'

on:
 push:
   branches: [ "main" ]
 workflow_dispatch:

permissions:
 contents: read
 id-token: write

jobs:
 terraform:
   name: 'Terraform'
   runs-on: ubuntu-latest
   
   steps:
   - name: Debug Secrets
     id: secrets-debug
     run: |
       echo "Checking CLIENTID..."
       if [[ -n "${{ secrets.CLIENTID }}" ]]; then
         echo "CLIENTID is present"
         echo "client_id=${{ secrets.CLIENTID }}" >> $GITHUB_ENV
       else
         echo "::error::CLIENTID is missing"
         exit 1
       fi

       echo "Checking CLIENTSECRET..."
       if [[ -n "${{ secrets.CLIENTSECRET }}" ]]; then
         echo "CLIENTSECRET is present"
         echo "client_secret=${{ secrets.CLIENTSECRET }}" >> $GITHUB_ENV
       else
         echo "::error::CLIENTSECRET is missing"
         exit 1
       fi

       echo "Checking SUBSCRIPTIONID..."
       if [[ -n "${{ secrets.SUBSCRIPTIONID }}" ]]; then
         echo "SUBSCRIPTIONID is present"
         echo "subscription_id=${{ secrets.SUBSCRIPTIONID }}" >> $GITHUB_ENV
       else
         echo "::error::SUBSCRIPTIONID is missing"
         exit 1
       fi

       echo "Checking TENANTID..."
       if [[ -n "${{ secrets.TENANTID }}" ]]; then
         echo "TENANTID is present"
         echo "tenant_id=${{ secrets.TENANTID }}" >> $GITHUB_ENV
       else
         echo "::error::TENANTID is missing"
         exit 1
       fi

   - name: Setup Azure Credentials
     id: setup-creds
     run: |
       AZURE_CREDS=$(jq -n \
         --arg cid "${{ env.client_id }}" \
         --arg cs "${{ env.client_secret }}" \
         --arg sid "${{ env.subscription_id }}" \
         --arg tid "${{ env.tenant_id }}" \
         '{clientId: $cid, clientSecret: $cs, subscriptionId: $sid, tenantId: $tid}')
       echo "azure_credentials=${AZURE_CREDS}" >> $GITHUB_OUTPUT

   - name: Checkout
     uses: actions/checkout@v4

   - name: 'Azure Login'
     uses: azure/login@v1
     with:
       creds: ${{ steps.setup-creds.outputs.azure_credentials }}
       enable-AzPSSession: false
       auth-type: SERVICE_PRINCIPAL
       environment: azurecloud
       allow-no-subscriptions: false
       audience: api://AzureADTokenExchange

   - name: 'Setup Terraform'
     uses: hashicorp/setup-terraform@v3
     with:
       terraform_version: '1.7.0'

   - name: 'Create and Format Backend Configuration'
     working-directory: ./terraform
     run: |
       # Create initial backend.tf
       cat > backend.tf << 'EOF'
         terraform {
           backend "azurerm" {
             resource_group_name  = "terraform-state-rg"
             storage_account_name = "tfstatemftfb413"
             container_name       = "tfstate"
             key                 = "terraform.tfstate"
           }
         }
       EOF
       
       # Format the file
       terraform fmt backend.tf
       
       # Print the formatted content
       cat backend.tf

   - name: 'Terraform Init'
     working-directory: ./terraform
     run: terraform init

   - name: 'Terraform Format Check'
     working-directory: ./terraform
     run: |
       # Run format check
       terraform fmt -check
       if [ $? -eq 0 ]; then
         echo "Formatting check passed"
       else
         echo "Formatting issues found"
         exit 1
       fi

   - name: 'Terraform Plan'
     working-directory: ./terraform
     run: |
       set +e
       terraform plan -detailed-exitcode -out=tfplan > plan_output.txt 2>&1
       PLAN_EXIT_CODE=$?
       cat plan_output.txt
       if [ $PLAN_EXIT_CODE -eq 1 ]; then
         echo "Terraform plan failed"
         exit 1
       fi
       echo "TERRAFORM_PLAN_EXIT_CODE=$PLAN_EXIT_CODE" >> $GITHUB_ENV

   - name: 'Terraform Apply'
     working-directory: ./terraform
     #if: github.ref == 'refs/heads/main' && env.TERRAFORM_PLAN_EXIT_CODE == 2
     run: |
       echo "Applying changes"
       terraform apply -auto-approve tfplan
   
   - name: 'Verify State'
     working-directory: ./terraform
     if: success() && github.ref == 'refs/heads/main'
     run: |
       echo "Verifying state file creation..."
       terraform state list